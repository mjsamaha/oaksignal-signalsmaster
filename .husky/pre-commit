#!/bin/sh
echo "üîí Running security checks..."

# Check if gitleaks is installed
if command -v gitleaks > /dev/null 2>&1; then
  echo "üîç Running Gitleaks scan on staged files..."
  gitleaks protect --staged --verbose
  GITLEAKS_EXIT=$?

  if [ $GITLEAKS_EXIT -ne 0 ]; then
    echo "‚ùå Gitleaks found secrets in your staged files!"
    echo "   Please remove secrets before committing."
    echo "   To skip this check (NOT RECOMMENDED): git commit --no-verify"
    exit 1
  fi
  echo "‚úÖ Gitleaks scan passed"
else
  echo "‚ö†Ô∏è  Gitleaks not installed - using basic checks"
  if [ -f "c:\Program Files\winget\winget.exe" ]; then
     echo "   Install: winget install gitleaks"
  else 
     echo "   Install Gitleaks: https://github.com/gitleaks/gitleaks"
  fi
fi

# Fallback: Basic pattern checks (runs even if Gitleaks is installed for extra protection)
echo "üîç Running basic secret patterns check..."

# Block environment files from being committed
if git diff --cached --name-status | grep -E "^[AM].*environment\.(ts|prod\.ts)$" > /dev/null 2>&1; then
  echo "‚ùå ERROR: Attempting to commit environment files!"
  echo "   Files: environment.ts, environment.prod.ts"
  echo "   These files are gitignored and should never be committed."
  exit 1
fi

# Check for Firebase API keys (but allow deletions)
if git diff --cached --diff-filter=AM | grep -E "AIzaSy[0-9A-Za-z_-]{33}" > /dev/null 2>&1; then
  echo "‚ùå ERROR: Firebase API key detected!"
  echo "   Remove the API key before committing."
  exit 1
fi

# Check for GitHub tokens
if git diff --cached --diff-filter=AM | grep -E "gh[ps]_[0-9A-Za-z]{36}" > /dev/null 2>&1; then
  echo "‚ùå ERROR: GitHub token detected!"
  exit 1
fi

# Check for AWS keys
if git diff --cached --diff-filter=AM | grep -E "AKIA[0-9A-Z]{16}" > /dev/null 2>&1; then
  echo "‚ùå ERROR: AWS access key detected!"
  exit 1
fi

# Check for private keys
if git diff --cached --diff-filter=AM | grep -E "-----BEGIN (RSA|OPENSSH|EC|DSA) PRIVATE KEY-----" > /dev/null 2>&1; then
  echo "‚ùå ERROR: Private key detected!"
  exit 1
fi

# Check for generic secret patterns (warning only)
if git diff --cached --diff-filter=AM | grep -iE "(password|secret|token|api[_-]?key).*[:=]\s*['\"][A-Za-z0-9_-]{20,}['\"]" > /dev/null 2>&1; then
  echo "‚ö†Ô∏è  WARNING: Possible secret pattern detected"
  echo "   Please review your changes carefully"
  echo "   If this is a false positive, continue with: git commit --no-verify"
  # Don't exit - just warn
fi

echo "‚úÖ Basic security checks passed"

# Run existing Lint task
npm run lint
